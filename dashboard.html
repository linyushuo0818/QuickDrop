<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniDrop Dashboard</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
    --bg: #0c0f12;
    --bg-2: #0f1318;
    --card: rgba(18, 22, 28, 0.9);
    --card-2: rgba(15, 19, 24, 0.8);
    --stroke: rgba(255, 255, 255, 0.08);
    --text: #f4f7f8;
    --muted: rgba(244, 247, 248, 0.62);
    --accent: #a4ff1a;
    --accent-2: #ff6a00;
    --success: #1ed760;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Archivo', 'Segoe UI', system-ui, sans-serif;
    margin: 0;
    color: var(--text);
    min-height: 100vh;
    background:
        radial-gradient(1200px 600px at 20% -20%, rgba(164, 255, 26, 0.15), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(255, 106, 0, 0.18), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
        linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
    background-size: 32px 32px;
    pointer-events: none;
    z-index: 0;
}

body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="140" height="140" filter="url(%23n)" opacity="0.08"/></svg>');
    opacity: 0.25;
    mix-blend-mode: soft-light;
    pointer-events: none;
    z-index: 0;
}

.wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 24px 80px;
    position: relative;
    z-index: 1;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-bottom: 26px;
}

.brand {
    font-family: 'Archivo', sans-serif;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 12px;
}

.brand::before {
    content: '';
    width: 12px;
    height: 12px;
    border-radius: 3px;
    background: var(--accent);
    box-shadow: 0 0 12px rgba(164, 255, 26, 0.6);
}

.status-badge {
    font-size: 12px;
    background: rgba(30, 215, 96, 0.18);
    color: var(--success);
    padding: 8px 14px;
    border-radius: 999px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid rgba(30, 215, 96, 0.35);
}

.status-dot {
    width: 8px;
    height: 8px;
    background: currentColor;
    border-radius: 50%;
}

.hero-section {
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: 24px;
    padding: 22px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) 220px;
    gap: 20px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
}

.ip-display {
    display: flex;
    flex-direction: column;
    gap: 14px;
    min-width: 0;
}

.ip-box {
    font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size: 24px;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.12);
    color: var(--text);
    padding: 14px 18px;
    border-radius: 14px;
    letter-spacing: 0.2px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.2s ease;
}

.ip-box:hover {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(164, 255, 26, 0.15);
}

.hero-hint {
    color: var(--muted);
    font-size: 13px;
    letter-spacing: 0.2px;
}

.settings-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
}

.btn {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.12);
    color: var(--text);
    padding: 0 18px;
    height: 42px;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn:hover {
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

.btn-primary {
    background: linear-gradient(120deg, var(--accent), #d8ff6b);
    border: none;
    color: #0c0f12;
    font-weight: 800;
}

.btn-primary:hover {
    box-shadow: 0 10px 24px rgba(164, 255, 26, 0.35);
}

.action-btn {
    width: 100%;
    height: 48px;
    justify-content: space-between;
    padding: 0 18px;
    background: rgba(255, 255, 255, 0.06);
}

.btn-on {
    background: rgba(30, 215, 96, 0.25);
    border-color: rgba(30, 215, 96, 0.45);
    color: #c9ffd9;
}

.btn-off {
    background: rgba(255, 106, 0, 0.1);
    border-color: rgba(255, 106, 0, 0.6);
    color: #ffc6a6;
}

.section-title {
    margin: 32px 0 16px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--muted);
}

.grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 18px;
}

.card {
    background: var(--card-2);
    border: 1px solid var(--stroke);
    border-radius: 18px;
    padding: 18px;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.25s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-4px);
    border-color: rgba(164, 255, 26, 0.5);
    box-shadow: 0 18px 28px rgba(0, 0, 0, 0.4);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.card-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.card-body {
    flex: 1;
    margin: 12px 0;
    font-size: 13px;
    color: var(--text);
    line-height: 1.5;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    word-break: break-all;
}

.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--muted);
}

.copy-btn {
    width: 30px;
    height: 30px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    color: var(--muted);
}

.copy-btn:hover {
    color: var(--text);
    border-color: rgba(255, 255, 255, 0.35);
}

.bg-red { background: rgba(255, 106, 0, 0.18); color: #ffb47f; }
.bg-blue { background: rgba(61, 153, 255, 0.2); color: #9ed0ff; }
.bg-green { background: rgba(30, 215, 96, 0.2); color: #b6f5c9; }
.bg-yellow { background: rgba(255, 214, 10, 0.2); color: #ffe9a6; }
.bg-purple { background: rgba(255, 255, 255, 0.12); color: #e4e4e4; }

.card.is-image {
    border: none;
    background: #0f1114;
}

.card-bg-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 18px;
    z-index: 0;
}

.card.is-image::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.1) 40%, rgba(0,0,0,0.7) 100%);
    z-index: 1;
}

.card.is-image .card-header,
.card.is-image .card-footer {
    position: relative;
    z-index: 2;
}

.card.is-image .card-body {
    display: none;
}

.card.is-image .card-footer {
    color: rgba(255, 255, 255, 0.85);
}

.card.is-image .card-icon,
.card.is-image .copy-btn {
    background: rgba(255, 255, 255, 0.15) !important;
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(6px);
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal {
    background: #11151b;
    padding: 24px;
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    width: 90%;
    max-width: 360px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
}

.close-btn {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border: none;
    padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
    margin-top: 15px;
    font-weight: 600;
}

.qr-placeholder {
    width: 180px;
    height: 180px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    margin: 16px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    font-size: 12px;
}

@media (max-width: 760px) {
    .header {
        flex-direction: column;
        align-items: flex-start;
    }

    .hero-section {
        grid-template-columns: 1fr;
    }

    .ip-box {
        font-size: 18px;
    }
}
</style>
</head>

<body>
    <div class="header">
        <div class="brand">OmniDrop</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div class="status-badge"><span class="status-dot"></span>RUNNING</div>
            <button id="btnAutoStart" class="btn" onclick="toggleAutostart()">?? ????: ...</button>
            <button class="btn" onclick="showQRCode()">?? ????</button>
            <button class="btn btn-primary" onclick="showCanvas()">?? ????</button>
            <button class="btn" onclick="loadHistory()">? ??</button>
        </div>
    </div>
<div style="display:flex; gap:10px; align-items:center;">
            <button id="btnAutoStart" class="btn" onclick="toggleAutostart()">üöÄ ÂºÄÊú∫Ëá™ÂêØ</button>
            <button class="btn" onclick="showQRCode()">üì± Êâ´Á†ÅËøûÊé•</button>
            <button class="btn btn-primary" onclick="showCanvas()">‚úçÔ∏è ÊâãÂÜôÊùø</button>
            <button class="btn" onclick="loadHistory()">üîÑ Âà∑Êñ∞</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay" id="qrModal" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal">
            <h3 style="margin:0 0 10px 0;">iPad ????</h3>
            <p style="color:var(--muted); font-size:13px; margin:0;">? iPad ?????????</p>
            <div id="qrContent" class="qr-placeholder">???...</div>
            <div style="font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.08); padding:8px; border-radius:10px; font-size:12px; word-break:break-all; color: var(--text);" id="qrUrl"></div>
            <button class="close-btn" onclick="document.getElementById('qrModal').style.display='none'">??</button>
        </div>
    </div>

    <!-- Canvas Modal -->
    <div class="modal-overlay" id="canvasModal" style="z-index: 2000;">
        <div class="modal" style="width: 95%; max-width: 900px; height: 80vh; max-height: 860px; display: flex; flex-direction: column; padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0;">????</h3>
                <button class="close-btn" style="margin:0; padding: 6px 14px;" onclick="closeCanvas()">??</button>
            </div>
            
            <div style="flex: 1; border: 1px dashed rgba(255,255,255,0.25); border-radius: 16px; position: relative; overflow: hidden; background: #ffffff; cursor: crosshair;" id="canvasContainer">
                <canvas id="drawingCanvas" style="display: block; width: 100%; height: 100%; touch-action: none;"></canvas>
            </div>

            <div style="margin-top: 15px; display: flex; gap: 15px; justify-content: center;">
                <button class="btn" onclick="clearCanvas()">?? ??</button>
                <button class="btn btn-primary" onclick="sendCanvas()" id="btnSendCanvas">?? ?????</button>
            </div>
        </div>
    </div>
    </div>

    <div class="wrapper">
        <div class="hero-section">
            <div class="ip-display">
                <div class="ip-box" onclick="copyIP()" id="ipArea">{{SERVER_ADDRESS}}</div>
                <div class="hero-hint" id="copyHint">???? ? ??? iPad ????</div>
            </div>
            <div class="settings-row">
                <button class="btn action-btn" onclick="openDir()">
                    <span style="font-size:18px;">??</span>
                    <span style="flex:1; text-align:left;">?????</span>
                </button>
                <button class="btn action-btn" onclick="selectFolder()">
                    <span style="font-size:18px;">??</span>
                    <span style="flex:1; text-align:left;">????</span>
                </button>
            </div>
        </div>

        <div class="section-title">üïí ÊúÄËøë‰º†Ëæì (History)</div>
        <div id="gridContainer" class="grid-container">
            <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">Âä†ËΩΩ‰∏≠...</div>
        </div>
    </div>

    <script>
        const colors = ['bg-red', 'bg-blue', 'bg-green', 'bg-yellow', 'bg-purple'];



        function copyIP() {
            const text = document.getElementById('ipArea').innerText;
            copyToClipboard(text, () => {
                const hint = document.getElementById('copyHint');
                hint.innerText = "‚úÖ Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø";
                hint.style.color = "var(--success-color)";
                setTimeout(() => {
                    hint.innerText = "ÁÇπÂáªÂ§çÂà∂ -> Á≤òË¥¥Âà∞ iPad Âø´Êç∑Êåá‰ª§";
                    hint.style.color = "var(--text-secondary)";
                }, 2000);
            });
        }

        async function copyToClipboard(text, onSuccess, type = 'text') {
            try {
                if (type === 'image' && navigator.clipboard && navigator.clipboard.write) {
                    try {
                        const response = await fetch(text);
                        const blob = await response.blob();
                        await navigator.clipboard.write([
                            new ClipboardItem({ [blob.type]: blob })
                        ]);
                        onSuccess();
                        return;
                    } catch (err) {
                        console.warn('Image copy failed, falling back to text', err);
                    }
                }

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text).then(onSuccess, () => fallbackCopy(text, onSuccess));
                } else {
                    fallbackCopy(text, onSuccess);
                }
            } catch (e) {
                console.error('Copy failed', e);
                alert('Â§çÂà∂Â§±Ë¥•');
            }
        }

        function fallbackCopy(text, onSuccess) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.top = "0";
            document.body.appendChild(ta);
            ta.select();
            try {
                if (document.execCommand('copy')) onSuccess();
                else alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
            } catch (e) { alert('Â§çÂà∂Â§±Ë¥•'); }
            document.body.removeChild(ta);
        }

        function loadHistory() {
            const container = document.getElementById('gridContainer');
            fetch('/history').then(r => r.json()).then(data => {
                container.innerHTML = '';
                if (!data.records || data.records.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
                    return;
                }

                data.records.slice(0, 20).forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.setAttribute('data-type', item.type);

                    const colorClass = colors[index % colors.length];
                    let icon = 'üìÑ';
                    let typeName = 'TEXT';
                    let contentHtml = `<div class="card-text">${escapeHtml(item.preview)}</div>`;
                    let bgImgTag = '';

                    if (item.type === 'image') {
                        icon = '???';
                        typeName = 'IMAGE';

                        const imgSrc = safeImageSrc(item.content);
    
                        if (imgSrc) {
                            // Immersive Mode
                            card.classList.add('is-image');
                            bgImgTag = `<img src="${imgSrc}" class="card-bg-img" alt="Background" onerror="this.style.display='none'; this.parentElement.style.backgroundColor='#eee';">`;
                            contentHtml = '';
                        } else {
                            contentHtml = '<div class="card-text">?????????</div>';
                        }
                    }
                    if (item.type === 'url') { icon = 'üîó'; typeName = 'LINK'; }
                    if (item.type === 'file') { icon = 'üìÅ'; typeName = 'FILE'; }

                    const timeStr = new Date(item.timestamp).toLocaleTimeString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                    card.innerHTML = `
                        ${bgImgTag}
                        <div class="card-header">
                            <div class="card-icon ${colorClass}">${icon}</div>
                            <div class="action-row" style="display:flex; gap:5px;">
                                <div class="copy-btn copy-clip-btn" title="Â§çÂà∂Âà∞ÁîµËÑë">üìã</div>
                            </div>
                        </div>
                        <div class="card-body" style="overflow:hidden;">${contentHtml}</div>
                        <div class="card-footer">
                            <span>${typeName}</span>
                            <span>${timeStr}</span>
                        </div>
                    `;

                    // Events
                    const copyBtn = card.querySelector('.copy-clip-btn');
                    if (copyBtn) copyBtn.onclick = (e) => { e.stopPropagation(); copyToClipboard(item.content, () => alert('‚úÖ Â∑≤Â§çÂà∂'), item.type); };

                    const pushBtn = card.querySelector('.push-btn');
                    if (pushBtn) pushBtn.onclick = (e) => { e.stopPropagation(); pushToiPad(item); };

                    card.onclick = () => copyToClipboard(item.content, () => alert('‚úÖ ÂÜÖÂÆπÂ∑≤Â§çÂà∂'), item.type);
                    container.appendChild(card);
                });
            }).catch(e => {
                console.error(e);
                container.innerHTML = '<div style="text-align:center; padding:20px;">Âä†ËΩΩÂ§±Ë¥•</div>';
            });
        }



        function toggleAutostart() {
            const btn = document.getElementById('btnAutoStart');
            const isEnabled = btn.classList.contains('btn-on');
            const newState = !isEnabled;

            fetch('/autostart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newState })
            }).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    updateAutoStartBtn(newState);
                } else alert('ËÆæÁΩÆÂ§±Ë¥•');
            });
        }

        function updateAutoStartBtn(enabled) {
            const btn = document.getElementById('btnAutoStart');
            if (enabled) {
                btn.classList.add('btn-on');
                btn.classList.remove('btn-off');
                btn.innerHTML = 'üöÄ ÂºÄÊú∫Ëá™ÂêØ: ON';
            } else {
                btn.classList.add('btn-off');
                btn.classList.remove('btn-on');
                btn.innerHTML = 'üöÄ ÂºÄÊú∫Ëá™ÂêØ: OFF';
            }
        }

        function openDir() { fetch('/open-dir', { method: 'POST' }); }

        
        function selectFolder() {
            fetch('/select-folder', { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.status !== 'success') return;
                    fetch('/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ dataDir: d.path })
                    }).then(r => r.json()).then(cfg => {
                        if (cfg.status === 'success') alert('??????????????? ' + d.path);
                        else alert('????????????: ' + (cfg.message || ''));
                    });
                });
        }

function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function safeImageSrc(raw) {
            if (!raw) return '';
            let src = String(raw).replace(/[\r\n\s]+/g, '');
            if (src.startsWith('data:image/')) {
                const allowed = [
                    'data:image/png;base64,',
                    'data:image/jpeg;base64,',
                    'data:image/jpg;base64,',
                    'data:image/gif;base64,',
                    'data:image/webp;base64,',
                    'data:image/bmp;base64,'
                ];
                if (!allowed.some((prefix) => src.startsWith(prefix))) return '';
                return /["'<>]/.test(src) ? '' : src;
            }
            if (src.startsWith('/9j/')) src = `data:image/jpeg;base64,${src}`;
            else if (src.startsWith('iVBORw')) src = `data:image/png;base64,${src}`;
            else if (src.startsWith('R0lGOD')) src = `data:image/gif;base64,${src}`;
            else if (src.startsWith('UklGR')) src = `data:image/webp;base64,${src}`;
            else return '';
            return /["'<>]/.test(src) ? '' : src;
        }

        function showQRCode() {
            const modal = document.getElementById('qrModal');
            const content = document.getElementById('qrContent');
            const urlText = document.getElementById('qrUrl');

            modal.style.display = 'flex';
            content.innerHTML = 'Âä†ËΩΩ‰∏≠...';
            urlText.innerText = '';

            fetch('/qrcode')
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        content.innerHTML = `<img src="${d.qrData}" style="width:100%;height:100%;">`;
                        urlText.innerText = d.url;
                    } else {
                        content.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•: ' + d.message;
                    }
                })
                .catch(e => {
                    content.innerHTML = 'ÁΩëÁªúÈîôËØØ';
                });
        }

        // Init
        fetch('/autostart').then(r => r.json()).then(d => {
            updateAutoStartBtn(d.enabled);
        });
        // Canvas Logic
        let canvas, ctx, isDrawing = false;
        let lastX = 0, lastY = 0;

        function showCanvas() {
            const modal = document.getElementById('canvasModal');
            modal.style.display = 'flex';
            
            // Init canvas after visible
            setTimeout(initCanvas, 100);
        }

        function closeCanvas() {
            document.getElementById('canvasModal').style.display = 'none';
        }

        function initCanvas() {
            const container = document.getElementById('canvasContainer');
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');

            // Resize canvas to match display size
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Style
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#000';

            // Events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch support
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            clearCanvas();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function sendCanvas() {
            const btn = document.getElementById('btnSendCanvas');
            btn.innerText = 'ÂèëÈÄÅ‰∏≠...';
            btn.disabled = true;

            // Get Base64
            const dataUrl = canvas.toDataURL('image/png');
            
            // Upload
            fetch('/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'image',
                    content: dataUrl, // Standard format
                    meta: { filename: `drawing_${Date.now()}.png`, source: 'web_canvas' }
                })
            })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    alert('‚úÖ ÂèëÈÄÅÊàêÂäüÔºÅ');
                    closeCanvas();
                    loadHistory();
                } else {
                    alert('ÂèëÈÄÅÂ§±Ë¥•: ' + d.message);
                }
            })
            .catch(e => {
                alert('ÁΩëÁªúÈîôËØØ');
                console.error(e);
            })
            .finally(() => {
                btn.innerText = 'üì§ ÂèëÈÄÅÂà∞ÁîµËÑë';
                btn.disabled = false;
            });
        }
        
        loadHistory();
    </script>
</body>

</html>
